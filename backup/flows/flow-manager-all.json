[
  {
    "id": "039cdff5-9878-4981-b836-d9d87b022a2c",
    "name": "【考试算分triggered-01】",
    "icon": "bolt",
    "color": "#6644FF",
    "description": "传来的参数是一个submitted_exams的id",
    "trigger": "operation",
    "options": {
      "return": "$last"
    },
    "operation": "9eb1833b-88fc-437e-8f73-ad411126b1c6",
    "operations": [
      {
        "id": "12a39586-c78d-47a0-9925-2bad4a6d033e",
        "name": "查询当前submit_chapter信息",
        "key": "submitted_paper_chapters",
        "type": "item-read",
        "position_x": 4,
        "position_y": 72,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{item_update_submitted_chapters[0]}}"
              }
            }
          }
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "1bbd3876-9619-4807-9ddf-27695bc18e61",
        "name": "查询当前submit_q 所属的submit chapter的所有submit_q",
        "key": "submitted_chapter_quesions",
        "type": "item-read",
        "position_x": 4,
        "position_y": 53,
        "options": {
          "collection": "submitted_questions",
          "query": {
            "filter": {
              "submitted_paper_chapter": {
                "_eq": "{{submitted_questions[0].submitted_paper_chapter}}"
              }
            }
          }
        },
        "resolve": "9678d7cb-7e9a-4531-b614-6ae17ad16ac6",
        "reject": null
      },
      {
        "id": "4f16ecdb-fa79-47d2-9880-a1355bade3df",
        "name": "读取当前章节的试卷的所有章节数据",
        "key": "item_read_paper_chapters",
        "type": "item-read",
        "position_x": 21,
        "position_y": 19,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "submitted_paper": {
                "_eq": "{{item_read_submitted_paper[0].id}}"
              }
            }
          }
        },
        "resolve": "dfd4dd1f-59d2-4d29-bb2e-41ee960f797a",
        "reject": null
      },
      {
        "id": "7e6fef02-bc68-4c0b-8304-7859e5569e61",
        "name": "得分总分更新到submitted_chapter",
        "key": "item_update_submitted_chapters",
        "type": "item-update",
        "position_x": 39,
        "position_y": 53,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{submitted_questions[0].submitted_paper_chapter}}"
              }
            }
          },
          "payload": {
            "score": "{{exec_sum_question_score}}"
          }
        },
        "resolve": "12a39586-c78d-47a0-9925-2bad4a6d033e",
        "reject": null
      },
      {
        "id": "886fd332-20f8-4092-8975-8bec0220d3a7",
        "name": "触发流程，先算每个章节的得分",
        "key": "trigger_submitted_paper_chapters",
        "type": "trigger",
        "position_x": 4,
        "position_y": 19,
        "options": {
          "payload": "{{item_read_submitted_paper[0].submitted_paper_chapters}}",
          "flow": "a7fcd0ee-d432-4d15-b4f7-f08594c48e0e"
        },
        "resolve": "4f16ecdb-fa79-47d2-9880-a1355bade3df",
        "reject": null
      },
      {
        "id": "9678d7cb-7e9a-4531-b614-6ae17ad16ac6",
        "name": "运行脚本求和question的score",
        "key": "exec_sum_question_score",
        "type": "exec",
        "position_x": 21,
        "position_y": 53,
        "options": {
          "code": "module.exports = async function(data) {\n    const chapter_question_list = data.submitted_chapter_quesions;\n\tlet sum_question_score = chapter_question_list\n    \t.reduce((sum, item) => sum + Number(item.score), 0);\n\treturn sum_question_score;\n}"
        },
        "resolve": "7e6fef02-bc68-4c0b-8304-7859e5569e61",
        "reject": null
      },
      {
        "id": "9eb1833b-88fc-437e-8f73-ad411126b1c6",
        "name": "注释",
        "key": "log_aqtyn",
        "type": "log",
        "position_x": 18,
        "position_y": 1,
        "options": {
          "message": "注意这里一定是action类型，要等更新事件完成了再执行，而非阻止事件本身。{{$trigger}}"
        },
        "resolve": "b7bf5398-86b6-4388-96c7-fb3c9e433dc1",
        "reject": null
      },
      {
        "id": "b7bf5398-86b6-4388-96c7-fb3c9e433dc1",
        "name": "读取该参考详情对应的submitted_paper数据",
        "key": "item_read_submitted_paper",
        "type": "item-read",
        "position_x": 36,
        "position_y": 1,
        "options": {
          "collection": "submitted_papers",
          "query": {
            "filter": {
              "submitted_exam": {
                "_eq": "{{$trigger}}"
              }
            }
          }
        },
        "resolve": "886fd332-20f8-4092-8975-8bec0220d3a7",
        "reject": null
      },
      {
        "id": "bcb9bfb7-0763-4142-8e80-79b35b701289",
        "name": "得分总分更新到submitted_peper",
        "key": "item_update_submitted_papers",
        "type": "item-update",
        "position_x": 5,
        "position_y": 37,
        "options": {
          "collection": "submitted_papers",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{item_read_submitted_paper[0].id}}"
              }
            }
          },
          "payload": {
            "score": "{{exec_sum_chapter_score}}"
          }
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "dfd4dd1f-59d2-4d29-bb2e-41ee960f797a",
        "name": "运行脚本求和chapter的score到paper",
        "key": "exec_sum_chapter_score",
        "type": "exec",
        "position_x": 38,
        "position_y": 19,
        "options": {
          "code": "module.exports = async function(data) {\n    const paper_chapter_list = data.item_read_paper_chapters;\n\tlet sum_chapter_score = paper_chapter_list\n    \t.reduce((sum, item) => sum + Number(item.score), 0);\n\treturn sum_chapter_score;\n}"
        },
        "resolve": "bcb9bfb7-0763-4142-8e80-79b35b701289",
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "0805b2ab-9634-4236-8943-bdb0291b6bb7",
    "name": "【考试发卷1-1】",
    "icon": "bolt",
    "color": null,
    "description": "每次exams_students有新增时，新增交卷详情",
    "trigger": "event",
    "options": {
      "type": "action",
      "scope": [
        "items.create"
      ],
      "collections": [
        "exams_students"
      ]
    },
    "operation": "3f98796a-e0ec-4cab-8fc2-c7dd3d06e323",
    "operations": [
      {
        "id": "092a3506-5dc0-4c10-b22f-8c027914e21e",
        "name": "记录到控制台",
        "key": "log_886of",
        "type": "log",
        "position_x": 3,
        "position_y": 19,
        "options": {
          "message": "{{item_read_exams[0].paper}}"
        },
        "resolve": "51d26687-de16-45c1-8458-12f148b56b74",
        "reject": null
      },
      {
        "id": "27396d66-84f4-45a8-a153-5073b2a48d48",
        "name": "记录到控制台",
        "key": "log_bp8bp",
        "type": "log",
        "position_x": 39,
        "position_y": 19,
        "options": {
          "message": "{{item_create_submitted_paper[0]}}"
        },
        "resolve": "4075532c-b40a-40b4-ba30-f88d1acb23c6",
        "reject": null
      },
      {
        "id": "3323ab50-e8e9-4a42-bb45-4f537770ae67",
        "name": "记录到控制台",
        "key": "log_4azwp",
        "type": "log",
        "position_x": 3,
        "position_y": 55,
        "options": {
          "message": "{{list_submitted_chapter_and_paper}}"
        },
        "resolve": "9f172b01-972d-4faf-a9b1-2b08860c237c",
        "reject": null
      },
      {
        "id": "3f98796a-e0ec-4cab-8fc2-c7dd3d06e323",
        "name": "Log to Console",
        "key": "log_to_console",
        "type": "log",
        "position_x": 19,
        "position_y": 1,
        "options": {
          "message": "{{$trigger}}"
        },
        "resolve": "ea7bf149-959b-4f9b-94b8-ec16c9cf6729",
        "reject": null
      },
      {
        "id": "4075532c-b40a-40b4-ba30-f88d1acb23c6",
        "name": "创建“交卷详情”",
        "key": "item_create_submitted_paper",
        "type": "item-create",
        "position_x": 3,
        "position_y": 37,
        "options": {
          "collection": "submitted_papers",
          "payload": {
            "source_type": "paper_prototype",
            "source_paper_prototype": "{{item_read_exams[0].paper_prototype}}",
            "submitted_exam": "{{item_create_submitted_exam[0]}}"
          }
        },
        "resolve": "6d28918d-0f57-4876-9dd1-1075e22664f8",
        "reject": null
      },
      {
        "id": "51d26687-de16-45c1-8458-12f148b56b74",
        "name": "根据考试id和学生id，生成“参考详情”",
        "key": "item_create_submitted_exam",
        "type": "item-create",
        "position_x": 21,
        "position_y": 19,
        "options": {
          "collection": "submitted_exams",
          "payload": {
            "exam": "{{$trigger.payload.exams_id}}",
            "student": "{{$trigger.payload.students_id}}",
            "submit_status": "todo"
          }
        },
        "resolve": "27396d66-84f4-45a8-a153-5073b2a48d48",
        "reject": null
      },
      {
        "id": "6d28918d-0f57-4876-9dd1-1075e22664f8",
        "name": "读取对应试卷信息",
        "key": "read_paper_chapter",
        "type": "item-read",
        "position_x": 21,
        "position_y": 37,
        "options": {
          "collection": "paper_prototypes",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{item_read_exams[0].paper_prototype}}"
              }
            }
          }
        },
        "resolve": "bc597879-68ff-431e-8002-b5747e20110b",
        "reject": null
      },
      {
        "id": "71050fb7-c7f2-4f1a-b22c-aa4e83cb49cb",
        "name": "查询该试卷所有章节",
        "key": "item_read_paper_chapters",
        "type": "item-read",
        "position_x": 3,
        "position_y": 73,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "submitted_paper": {
                "_eq": "{{ item_create_submitted_paper[0] }}"
              }
            }
          }
        },
        "resolve": "9c579a00-2ac4-473c-822d-38928c1f9553",
        "reject": null
      },
      {
        "id": "9213d7e6-3ce0-4db1-a775-fc549d1ac86d",
        "name": "记录到控制台",
        "key": "log_65wvp",
        "type": "log",
        "position_x": 39,
        "position_y": 55,
        "options": {
          "message": "传递循环"
        },
        "resolve": "71050fb7-c7f2-4f1a-b22c-aa4e83cb49cb",
        "reject": null
      },
      {
        "id": "9c579a00-2ac4-473c-822d-38928c1f9553",
        "name": "计算该试卷的所有章节总分值",
        "key": "sum_chapters_point_value",
        "type": "exec",
        "position_x": 21,
        "position_y": 73,
        "options": {
          "code": "module.exports = async function(data) {\n    const paper_chapter_list = data.item_read_paper_chapters;\n\tlet sum_chapter_point_value = paper_chapter_list\n    \t.reduce((sum, item) => sum + Number(item.point_value), 0);\n\treturn sum_chapter_point_value;\n}"
        },
        "resolve": "ca27759d-8ee4-45a2-8454-4e32ce684b30",
        "reject": null
      },
      {
        "id": "9f172b01-972d-4faf-a9b1-2b08860c237c",
        "name": "触发循环试卷中的每个章节（附上submitted_paper的id）",
        "key": "trigger_submitted_chapters",
        "type": "trigger",
        "position_x": 21,
        "position_y": 55,
        "options": {
          "payload": "{{list_submitted_chapter_and_paper}}",
          "flow": "3ccbaca9-0bc8-4b06-b736-03120ba3bc70"
        },
        "resolve": "9213d7e6-3ce0-4db1-a775-fc549d1ac86d",
        "reject": null
      },
      {
        "id": "bc597879-68ff-431e-8002-b5747e20110b",
        "name": "给章节列表添加上对应submitted_paper数据，返回一个列表",
        "key": "list_submitted_chapter_and_paper",
        "type": "exec",
        "position_x": 39,
        "position_y": 37,
        "options": {
          "code": "module.exports = async function(data) {\n    const chapterList = data.read_paper_chapter[0].paper_prototype_chapters;\n\n    // 为每个元素添加 \"student\" 属性\n    const updatedList = chapterList.map(item => ({\n        paper_prototype_chapter:item,\n        submitted_paper: \"{{ item_create_submitted_paper[0] }}\",\n    }));\n\treturn updatedList;\n}"
        },
        "resolve": "3323ab50-e8e9-4a42-bb45-4f537770ae67",
        "reject": null
      },
      {
        "id": "ca27759d-8ee4-45a2-8454-4e32ce684b30",
        "name": "更新答卷总分值",
        "key": "item_update_y81eu",
        "type": "item-update",
        "position_x": 39,
        "position_y": 73,
        "options": {
          "collection": "submitted_papers",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{item_create_submitted_paper[0]}}"
              }
            }
          },
          "payload": {
            "point_value": "{{sum_chapters_point_value}}"
          }
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "ea7bf149-959b-4f9b-94b8-ec16c9cf6729",
        "name": "查找本场考试数据",
        "key": "item_read_exams",
        "type": "item-read",
        "position_x": 37,
        "position_y": 1,
        "options": {
          "collection": "exams",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.payload.exams_id}}"
              }
            }
          }
        },
        "resolve": "092a3506-5dc0-4c10-b22f-8c027914e21e",
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "0fce553e-9e3e-4e0d-8b34-94eeccf55ffc",
    "name": "【考试算分trigger-01】手动触发",
    "icon": "bolt",
    "color": null,
    "description": null,
    "trigger": "manual",
    "options": {
      "collections": [
        "submitted_exams"
      ]
    },
    "operation": "fdce25fe-dc7e-4cfe-b984-20089a82ab9c",
    "operations": [
      {
        "id": "fdce25fe-dc7e-4cfe-b984-20089a82ab9c",
        "name": "触发流程",
        "key": "trigger_hhq4c",
        "type": "trigger",
        "position_x": 19,
        "position_y": 1,
        "options": {
          "flow": "039cdff5-9878-4981-b836-d9d87b022a2c",
          "payload": "{{$trigger.body.keys}}"
        },
        "resolve": null,
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "1ab7f738-7726-4597-97a8-1b064994dba6",
    "name": "【考试发卷1-3】",
    "icon": "bolt",
    "color": null,
    "description": "循环把章节题拉到submitted_questions，要附带submitted_chapter信息",
    "trigger": "operation",
    "options": {
      "return": "$last"
    },
    "operation": "b9116bf1-6d04-47d3-bf99-de41dd9b0714",
    "operations": [
      {
        "id": "01b0c382-3789-4b85-a46f-00b62e9fe91f",
        "name": "加总所有题目分值",
        "key": "sum_questions_point_value",
        "type": "exec",
        "position_x": 21,
        "position_y": 37,
        "options": {
          "code": "module.exports = async function(data) {\n    const chapter_question_list = data.submitted_chapter_questions;\n\tlet sum_point_value = chapter_question_list\n    \t.reduce((sum, item) => sum + Number(item.point_value), 0);\n\treturn sum_point_value;\n}"
        },
        "resolve": "04ca0feb-8021-4c9c-9afe-a97f1d27cc80",
        "reject": null
      },
      {
        "id": "04ca0feb-8021-4c9c-9afe-a97f1d27cc80",
        "name": "更新数据",
        "key": "item_update_6hsiu",
        "type": "item-update",
        "position_x": 39,
        "position_y": 37,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.submitted_paper_chapter}}"
              }
            }
          },
          "payload": {
            "point_value": "{{sum_questions_point_value}}"
          }
        },
        "resolve": "a36e80f9-c537-4866-ad56-4c682c6a7fe5",
        "reject": null
      },
      {
        "id": "39d61045-4a49-4229-82c2-a5978deda66a",
        "name": "计算该试卷的所有章节总分值",
        "key": "sum_chapters_point_value",
        "type": "exec",
        "position_x": 39,
        "position_y": 55,
        "options": {
          "code": "module.exports = async function(data) {\n    const paper_chapter_list = data.item_read_paper_chapters;\n\tlet sum_chapter_point_value = paper_chapter_list\n    \t.reduce((sum, item) => sum + Number(item.point_value), 0);\n\treturn sum_chapter_point_value;\n}"
        },
        "resolve": "d98f452f-287a-4654-b8bf-9687fe56e6e1",
        "reject": null
      },
      {
        "id": "4bb8e18d-d6eb-4134-bb1f-ccbedd3de67f",
        "name": "计算该题目分值（根据题型）[备份，旧版]",
        "key": "point_values_ohdoi_old",
        "type": "exec",
        "position_x": 1,
        "position_y": 20,
        "options": {
          "code": "module.exports = async function(data) {\n    // 按id检索的，所以必定列表里只有一个元素。\n\tconst questionType = data.item_read_question[0].type;\n    const payload = data.$trigger;\n    let questionPointValue=0; // 默认值为0\n    let questionIncompletePointValue=0; // 默认值为0\n    if (questionType === \"q_mc_single\") {\n        questionPointValue = payload.q_mc_single_point_value;\n    } else if (questionType === \"q_mc_multi\") {\n        questionPointValue = payload.q_mc_multi_point_value;\n        questionIncompletePointValue = payload.q_mc_multi_incomplete_point_value;\n    } else if (questionType === \"q_mc_binary\") {\n        questionPointValue = payload.q_mc_binary_point_value;\n    } else if (questionType === \"q_mc_flexible\") {\n        questionPointValue = payload.q_mc_flexible_point_value;\n        questionIncompletePointValue = payload.q_mc_flexible_incomplete_point_value;\n    } \n\treturn {\n    \tquestionPointValue,\n        questionIncompletePointValue\n    };\n}"
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "521a7ed1-42a6-4bb8-8633-6b174475769b",
        "name": "查询submitted_chapter的所有questions",
        "key": "submitted_chapter_questions",
        "type": "item-read",
        "position_x": 3,
        "position_y": 37,
        "options": {
          "collection": "submitted_questions",
          "query": {
            "filter": {
              "submitted_paper_chapter": {
                "_eq": "{{$trigger.submitted_paper_chapter}}"
              }
            }
          }
        },
        "resolve": "01b0c382-3789-4b85-a46f-00b62e9fe91f",
        "reject": null
      },
      {
        "id": "538a6d00-b88c-4782-853a-6068bfb5090c",
        "name": "查询该试卷所有章节",
        "key": "item_read_paper_chapters",
        "type": "item-read",
        "position_x": 21,
        "position_y": 55,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "submitted_paper": {
                "_eq": "{{item_read_chapter_paper[0].submitted_paper}}"
              }
            }
          }
        },
        "resolve": "39d61045-4a49-4229-82c2-a5978deda66a",
        "reject": null
      },
      {
        "id": "60176534-1700-4a63-aac1-76284dafc438",
        "name": "计算该题目分值（根据题型）、记录正确答案",
        "key": "point_values",
        "type": "exec",
        "position_x": 18,
        "position_y": 20,
        "options": {
          "code": "module.exports = async function(data) {\n    // 按id检索的，所以必定列表里只有一个元素。\n\tconst questionType = data.item_read_question[0].type;\n    const payload = data.$trigger;\n    let questionPointValue=0; // 默认值为0\n    let questionIncompletePointValue=0; // 默认值为0\n    let correct_ans = data.item_read_question[0].answer;\n    if (questionType === \"q_mc_single\") {\n        questionPointValue = payload.q_mc_single_point_value;\n    } else if (questionType === \"q_mc_multi\") {\n        questionPointValue = payload.q_mc_multi_point_value;\n        questionIncompletePointValue = payload.q_mc_multi_incomplete_point_value;\n    } else if (questionType === \"q_mc_binary\") {\n        questionPointValue = payload.q_mc_binary_point_value;\n    } else if (questionType === \"q_mc_flexible\") {\n        questionPointValue = payload.q_mc_flexible_point_value;\n        questionIncompletePointValue = payload.q_mc_flexible_incomplete_point_value;\n    } \n\treturn {\n        correct_ans,\n    \tquestionPointValue,\n        questionIncompletePointValue\n    };\n}"
        },
        "resolve": "9fbf5e49-b8d9-4f42-b3da-a0202e101e53",
        "reject": null
      },
      {
        "id": "778c0157-349e-4827-8102-618e5dca88a7",
        "name": "查询该题目题型",
        "key": "item_read_question",
        "type": "item-read",
        "position_x": 37,
        "position_y": 1,
        "options": {
          "collection": "questions",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.questions_id}}"
              }
            }
          }
        },
        "resolve": "60176534-1700-4a63-aac1-76284dafc438",
        "reject": null
      },
      {
        "id": "9fbf5e49-b8d9-4f42-b3da-a0202e101e53",
        "name": "创建submitted_questions",
        "key": "create_submitted_questions",
        "type": "item-create",
        "position_x": 35,
        "position_y": 19,
        "options": {
          "collection": "submitted_questions",
          "payload": {
            "question_type": "{{item_read_question[0].type}}",
            "question": "{{$trigger.questions_id}}",
            "sort_in_chapter": "{{$trigger.sort_in_chapter}}",
            "submitted_paper_chapter": "{{$trigger.submitted_paper_chapter}}",
            "point_value": "{{point_values.questionPointValue}}",
            "incomplete_point_value": "{{point_values.questionIncompletePointValue}}",
            "correct_ans": "{{point_values.correct_ans}}"
          }
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "a36e80f9-c537-4866-ad56-4c682c6a7fe5",
        "name": "查询该chapter所属paper",
        "key": "item_read_chapter_paper",
        "type": "item-read",
        "position_x": 3,
        "position_y": 55,
        "options": {
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.submitted_paper_chapter}}"
              }
            }
          },
          "collection": "submitted_paper_chapters"
        },
        "resolve": "538a6d00-b88c-4782-853a-6068bfb5090c",
        "reject": null
      },
      {
        "id": "b9116bf1-6d04-47d3-bf99-de41dd9b0714",
        "name": "记录到控制台",
        "key": "log_7lhga",
        "type": "log",
        "position_x": 19,
        "position_y": 1,
        "options": {
          "message": "{{$last}}"
        },
        "resolve": "778c0157-349e-4827-8102-618e5dca88a7",
        "reject": null
      },
      {
        "id": "d98f452f-287a-4654-b8bf-9687fe56e6e1",
        "name": "更新答卷总分值",
        "key": "item_update_y81eu",
        "type": "item-update",
        "position_x": 57,
        "position_y": 55,
        "options": {
          "collection": "submitted_papers",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{item_read_chapter_paper[0].submitted_paper}}"
              }
            }
          },
          "payload": {
            "point_value": "{{sum_chapters_point_value}}"
          }
        },
        "resolve": null,
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "280845bc-c67f-4a9f-b5c2-9f628d65f156",
    "name": "【字段】题库复制子表字段到父表",
    "icon": "bolt",
    "color": null,
    "description": "把详情里的题干复制到题目",
    "trigger": "event",
    "options": {
      "type": "action",
      "scope": [
        "items.create",
        "items.update",
        "items.delete"
      ],
      "collections": [
        "q_mc_single",
        "q_mc_multi",
        "q_mc_binary",
        "q_mc_flexible"
      ]
    },
    "operation": null,
    "operations": [
      {
        "id": "0548a1ae-32e9-46fc-92bf-ad40adca270d",
        "name": "条件",
        "key": "condition_5bbhc",
        "type": "condition",
        "position_x": 26,
        "position_y": 1,
        "options": {
          "filter": {
            "$trigger": {
              "category": {
                "_eq": "Example"
              }
            }
          }
        },
        "resolve": null,
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "3ccbaca9-0bc8-4b06-b736-03120ba3bc70",
    "name": "【考试发卷1-2】",
    "icon": "bolt",
    "color": null,
    "description": "循环submitted paper里的每个章节到submitted_chapters",
    "trigger": "operation",
    "options": {
      "return": "$last"
    },
    "operation": "ed7bf8d4-d551-47b5-a1cf-a912bd4adbaa",
    "operations": [
      {
        "id": "04c8e93d-fe3d-4fe0-b6b1-51594082d2e4",
        "name": "把submitted_chapter和chapter加入列表每项",
        "key": "list_with_submitted_chapter",
        "type": "exec",
        "position_x": 39,
        "position_y": 19,
        "options": {
          "code": "module.exports = async function(data) {\n    const chapterList = data.item_read_chapter_questions;\n\n    // 为每个元素添加 \"submitted_chapter\" 属性\n    const updatedList = chapterList.map(item => ({\n        questions_id: item.questions_id,\n        sort_in_chapter: item.sort_in_chapter,\n        submitted_paper_chapter: \"{{ create_submitted_paper_chapter[0] }}\",\n        q_mc_single_point_value: \"{{ item_read_chapter[0].q_mc_single_point_value }}\",\n        q_mc_multi_point_value: \"{{ item_read_chapter[0].q_mc_multi_point_value }}\",\n        q_mc_multi_incomplete_point_value: \"{{ item_read_chapter[0].q_mc_multi_incomplete_point_value }}\",\n        q_mc_binary_point_value: \"{{ item_read_chapter[0].q_mc_binary_point_value }}\",\n        q_mc_flexible_point_value: \"{{ item_read_chapter[0].q_mc_flexible_point_value }}\",\n        q_mc_flexible_incomplete_point_value: \"{{ item_read_chapter[0].q_mc_flexible_incomplete_point_value }}\",\n        // 把试卷原型章节也包含进去，方便查询\n    }));\n\treturn updatedList;\n}"
        },
        "resolve": "2b761712-5c75-49e8-99c4-a2f25b7e6d17",
        "reject": null
      },
      {
        "id": "09d597fe-6477-41d9-a91c-7d25dc5c249d",
        "name": "通过M2M表（paper_prototype_chapter_questions），找对应章节的题目列表",
        "key": "item_read_chapter_questions",
        "type": "item-read",
        "position_x": 21,
        "position_y": 19,
        "options": {
          "collection": "paper_prototype_chapters_questions",
          "query": {
            "filter": {
              "paper_prototype_chapters_id": {
                "_eq": "{{$trigger.paper_prototype_chapter}}"
              }
            }
          }
        },
        "resolve": "04c8e93d-fe3d-4fe0-b6b1-51594082d2e4",
        "reject": null
      },
      {
        "id": "269a706d-33fd-40cc-9b4f-ecf4325399e7",
        "name": "新增submitted_paper_chapter",
        "key": "create_submitted_paper_chapter",
        "type": "item-create",
        "position_x": 3,
        "position_y": 19,
        "options": {
          "collection": "submitted_paper_chapters",
          "payload": {
            "sort_in_paper": "{{item_read_chapter[0].sort_in_paper}}",
            "source_paper_prototype_chapter": "{{$trigger.paper_prototype_chapter}}",
            "submitted_paper": "{{$trigger.submitted_paper}}"
          }
        },
        "resolve": "09d597fe-6477-41d9-a91c-7d25dc5c249d",
        "reject": null
      },
      {
        "id": "2b761712-5c75-49e8-99c4-a2f25b7e6d17",
        "name": "循环创建submitted_questions",
        "key": "create_submitted_questions",
        "type": "trigger",
        "position_x": 3,
        "position_y": 37,
        "options": {
          "flow": "1ab7f738-7726-4597-97a8-1b064994dba6",
          "payload": "{{list_with_submitted_chapter}}"
        },
        "resolve": "c60559df-0bdd-4fee-a08a-ec4254d28a94",
        "reject": null
      },
      {
        "id": "42fb1ae7-2acf-4418-bae8-557b60084730",
        "name": "更新数据",
        "key": "item_update_6hsiu",
        "type": "item-update",
        "position_x": 39,
        "position_y": 55,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{create_submitted_paper_chapter[0]}}"
              }
            }
          },
          "payload": {
            "point_value": "{{sum_questions_point_value}}"
          }
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "516eee10-e2d0-4273-8a16-61fdd3da9ad1",
        "name": "读取章节（的判分规则）",
        "key": "item_read_chapter",
        "type": "item-read",
        "position_x": 37,
        "position_y": 1,
        "options": {
          "collection": "paper_prototype_chapters",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.paper_prototype_chapter}}"
              }
            }
          }
        },
        "resolve": "269a706d-33fd-40cc-9b4f-ecf4325399e7",
        "reject": null
      },
      {
        "id": "c60559df-0bdd-4fee-a08a-ec4254d28a94",
        "name": "查询submitted_chapter的所有questions",
        "key": "submitted_chapter_questions",
        "type": "item-read",
        "position_x": 3,
        "position_y": 55,
        "options": {
          "collection": "submitted_questions",
          "query": {
            "filter": {
              "submitted_paper_chapter": {
                "_eq": "{{create_submitted_paper_chapter[0]}}"
              }
            }
          }
        },
        "resolve": "e6f6956c-a8d2-4b5a-8441-c3e51e56c89e",
        "reject": null
      },
      {
        "id": "e6f6956c-a8d2-4b5a-8441-c3e51e56c89e",
        "name": "加总所有题目分值",
        "key": "sum_questions_point_value",
        "type": "exec",
        "position_x": 21,
        "position_y": 55,
        "options": {
          "code": "module.exports = async function(data) {\n    const chapter_question_list = data.submitted_chapter_questions;\n\tlet sum_point_value = chapter_question_list\n    \t.reduce((sum, item) => sum + Number(item.point_value), 0);\n\treturn sum_point_value;\n}"
        },
        "resolve": "42fb1ae7-2acf-4418-bae8-557b60084730",
        "reject": null
      },
      {
        "id": "ed7bf8d4-d551-47b5-a1cf-a912bd4adbaa",
        "name": "记录到控制台",
        "key": "log_eg3y7",
        "type": "log",
        "position_x": 19,
        "position_y": 1,
        "options": {
          "message": "{{$last}}"
        },
        "resolve": "516eee10-e2d0-4273-8a16-61fdd3da9ad1",
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "3e62899a-a4be-4239-a971-cf9f15a9afb2",
    "name": "【分值计算】章节、试卷分值（自动，保存时更新）",
    "icon": "bolt",
    "color": null,
    "description": "以后还得是要么全都是计算字段，要么全都通过flow来计算。不然不同步。",
    "trigger": "event",
    "options": {
      "type": "action",
      "scope": [
        "items.create",
        "items.update"
      ],
      "collections": [
        "paper_prototype_chapters"
      ]
    },
    "operation": "ce3be8d9-c1ce-4168-8129-6fe8600cfcd0",
    "operations": [
      {
        "id": "29349a82-aa09-4546-adfd-ed3acbf37912",
        "name": "计算各题型数量",
        "key": "sum_question_type_num",
        "type": "exec",
        "position_x": 21,
        "position_y": 37,
        "options": {
          "code": "module.exports = async function(data) {\n    const questionList = data.item_read_questions;\n    let sum_q_mc_single = 0;\n    let sum_q_mc_multi = 0;\n    let sum_q_mc_binary = 0;\n    let sum_q_mc_flexible = 0;\n\n\tfor (let i = 0; i < questionList.length; i++) {\n\t\tif (questionList[i].type === \"q_mc_single\") {\n    \t\tsum_q_mc_single += 1;\n\t\t}\n\t\tif (questionList[i].type === \"q_mc_multi\") {\n    \t\tsum_q_mc_multi += 1;\n\t\t}\n\t\tif (questionList[i].type === \"q_mc_binary\") {\n    \t\tsum_q_mc_binary += 1;\n\t\t}\n\t\tif (questionList[i].type === \"q_mc_flexible\") {\n    \t\tsum_q_mc_flexible += 1;\n\t\t}\n\t};\n    \n    return {\n        sum_q_mc_single,\n        sum_q_mc_multi,\n        sum_q_mc_binary,\n        sum_q_mc_flexible,\n    }\n}"
        },
        "resolve": "d1a4f83a-a909-431f-9de6-0c61bde328bb",
        "reject": null
      },
      {
        "id": "38b33f97-7caa-4e9b-a68b-07c669b56b66",
        "name": "只留下题目id",
        "key": "question_list",
        "type": "exec",
        "position_x": 39,
        "position_y": 19,
        "options": {
          "code": "module.exports = async function(data) {\n    const chapterQuestionList = data.item_read_chapter_questions;\n\n    // 为每个元素添加 \"student\" 属性\n    const questionIdList = chapterQuestionList.map(item => (\n    \titem.questions_id\n    ));\n\treturn questionIdList;\n}"
        },
        "resolve": "cff1f0c8-95e4-4ba3-b891-48f34c999412",
        "reject": null
      },
      {
        "id": "8547f8ed-5796-4b81-9f6a-fe87b060ec99",
        "name": "更新total_point_value",
        "key": "item_update_total_point_value",
        "type": "item-update",
        "position_x": 39,
        "position_y": 55,
        "options": {
          "collection": "paper_prototype_chapters",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{chapter_id}}"
              }
            }
          },
          "payload": {
            "total_point_value": "{{sum_point_value}}"
          }
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "87f6ecbe-1f2b-4d66-a2c7-9ffb7c1011db",
        "name": "计算各题型的总分值",
        "key": "sum_question_type_point",
        "type": "exec",
        "position_x": 3,
        "position_y": 55,
        "options": {
          "code": "module.exports = async function(data) {\n\tconst q_num = data.sum_question_type_num;\n    const chapter = data.item_read_chapter[0];\n    let sum_point_value_q_mc_single = chapter.q_mc_single_point_value * q_num.sum_q_mc_single;\n    let sum_point_value_q_mc_multi = chapter.q_mc_multi_point_value * q_num.sum_q_mc_multi;\n    let sum_point_value_q_mc_binary = chapter.q_mc_binary_point_value * q_num.sum_q_mc_binary;\n    let sum_point_value_q_mc_flexible = chapter.q_mc_flexible_point_value * q_num.sum_q_mc_flexible;\n    \n\treturn {\n    \tsum_point_value_q_mc_single,\n        sum_point_value_q_mc_multi,\n        sum_point_value_q_mc_binary,\n        sum_point_value_q_mc_flexible\n    };\n}"
        },
        "resolve": "f77d2984-faa6-417c-a958-2a5258f1c364",
        "reject": null
      },
      {
        "id": "a8655efc-04bb-4851-af4c-59c8a025154b",
        "name": "记录到控制台",
        "key": "log_aex4w",
        "type": "log",
        "position_x": 21,
        "position_y": 19,
        "options": {
          "message": "{{$last}}"
        },
        "resolve": "38b33f97-7caa-4e9b-a68b-07c669b56b66",
        "reject": null
      },
      {
        "id": "b4b19a25-1a5d-438e-a606-2280e7823baa",
        "name": "读取所有对应章节题目",
        "key": "item_read_chapter_questions",
        "type": "item-read",
        "position_x": 3,
        "position_y": 19,
        "options": {
          "collection": "paper_prototype_chapters_questions",
          "query": {
            "filter": {
              "paper_prototype_chapters_id": {
                "_eq": "{{chapter_id}}"
              }
            }
          }
        },
        "resolve": "a8655efc-04bb-4851-af4c-59c8a025154b",
        "reject": null
      },
      {
        "id": "ce3be8d9-c1ce-4168-8129-6fe8600cfcd0",
        "name": "根据事件类型确定chapter_id",
        "key": "chapter_id",
        "type": "exec",
        "position_x": 21,
        "position_y": 1,
        "options": {
          "code": "module.exports = async function(data) {\n    let chapter_id;\n\tif (data.$trigger.event === \"paper_prototype_chapters.items.create\"){\n        chapter_id = data.$trigger.key;\n    } else {\n        chapter_id = data.$trigger.keys[0];\n    }\n\treturn chapter_id;\n}"
        },
        "resolve": "b4b19a25-1a5d-438e-a606-2280e7823baa",
        "reject": null
      },
      {
        "id": "cff1f0c8-95e4-4ba3-b891-48f34c999412",
        "name": "题目列表",
        "key": "item_read_questions",
        "type": "item-read",
        "position_x": 3,
        "position_y": 37,
        "options": {
          "collection": "questions",
          "query": {
            "filter": {
              "id": {
                "_in": "{{question_list}}"
              }
            }
          }
        },
        "resolve": "29349a82-aa09-4546-adfd-ed3acbf37912",
        "reject": null
      },
      {
        "id": "d1a4f83a-a909-431f-9de6-0c61bde328bb",
        "name": "读取该章节信息",
        "key": "item_read_chapter",
        "type": "item-read",
        "position_x": 39,
        "position_y": 37,
        "options": {
          "collection": "paper_prototype_chapters",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{chapter_id}}"
              }
            }
          }
        },
        "resolve": "87f6ecbe-1f2b-4d66-a2c7-9ffb7c1011db",
        "reject": null
      },
      {
        "id": "f77d2984-faa6-417c-a958-2a5258f1c364",
        "name": "加总所有题型的分值",
        "key": "sum_point_value",
        "type": "exec",
        "position_x": 21,
        "position_y": 55,
        "options": {
          "code": "module.exports = async function(data) {\n    const sum = Object\n    \t.values(data.sum_question_type_point)\n    \t.reduce((acc, value) => acc + value, 0);\n    \t// acc是累加器，value是当前值\n\treturn sum;\n}"
        },
        "resolve": "8547f8ed-5796-4b81-9f6a-fe87b060ec99",
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "51562888-8cd0-4e67-8813-c815871db59e",
    "name": "【考试算分】自动执行（仅更新当题得分）",
    "icon": "bolt",
    "color": null,
    "description": "每次submitted_questions答案更新时，得分更新（但不要向上汇总！）",
    "trigger": "event",
    "options": {
      "type": "action",
      "scope": [
        "items.update"
      ],
      "collections": [
        "submitted_questions"
      ]
    },
    "operation": "cab37412-6cfb-44be-98f7-c7b8b0538195",
    "operations": [
      {
        "id": "088efa63-4cbe-4796-896d-b4b19adc4c43",
        "name": "更新submitted_questions_score",
        "key": "submitted_questions_score",
        "type": "item-update",
        "position_x": 21,
        "position_y": 37,
        "options": {
          "payload": {
            "score": "{{exec_compute_score.score}}"
          },
          "collection": "submitted_questions",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.keys[0]}}"
              }
            }
          }
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "6ed3d428-dd0e-45b5-802d-8aa2f3b64084",
        "name": "打印submitted_questions[0]详情",
        "key": "log_kphe8",
        "type": "log",
        "position_x": 52,
        "position_y": 1,
        "options": {
          "message": "{{submitted_questions[0]}}"
        },
        "resolve": "aba69584-435c-40aa-ae30-c9f668deeced",
        "reject": null
      },
      {
        "id": "938d3548-e125-4354-9dbc-d53457a9add4",
        "name": "读取原题目（为了获得答案）[弃用，现在直接把原题目答案存在submitted_question中]",
        "key": "item_read_questions",
        "type": "item-read",
        "position_x": 21,
        "position_y": 19,
        "options": {
          "collection": "questions",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{submitted_questions[0].question}}"
              }
            }
          }
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "aba69584-435c-40aa-ae30-c9f668deeced",
        "name": "根据题型定义学生提交的答案（字符串）",
        "key": "submitted_answer",
        "type": "exec",
        "position_x": 3,
        "position_y": 19,
        "options": {
          "code": "module.exports = async function(data) {\n    const q = data.submitted_questions[0];\n\tconst q_type = q.question_type;\n\tlet submitted_answer;\n    if (q_type === \"q_mc_single\") {\n        submitted_answer = q.submitted_ans_q_mc_single;\n    } else if (q_type === \"q_mc_multi\") {\n        submitted_answer = JSON.stringify(q.submitted_ans_q_mc_multi);\n    } else if (q_type === \"q_mc_binary\") {\n        submitted_answer = q.submitted_ans_q_mc_binary;\n    } else if (q_type === \"q_mc_flexible\") {\n        submitted_answer = JSON.stringify(q.submitted_ans_q_mc_flexible);\n    }\n\t// 为避免类型混乱，先全都转化为字符串来存储。\n\treturn submitted_answer;\n}"
        },
        "resolve": "f6edda51-ac32-4e82-a625-8d6a4df7abb5",
        "reject": null
      },
      {
        "id": "c520909d-826a-4ff7-a66e-8d191ba3246d",
        "name": "读取submitted_questions",
        "key": "submitted_questions",
        "type": "item-read",
        "position_x": 35,
        "position_y": 1,
        "options": {
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.keys[0]}}"
              }
            }
          },
          "collection": "submitted_questions"
        },
        "resolve": "6ed3d428-dd0e-45b5-802d-8aa2f3b64084",
        "reject": null
      },
      {
        "id": "cab37412-6cfb-44be-98f7-c7b8b0538195",
        "name": "注意",
        "key": "log_jftwy",
        "type": "log",
        "position_x": 18,
        "position_y": 1,
        "options": {
          "message": "注意这里一定是action类型，要等更新事件完成了再执行，而非阻止事件本身。"
        },
        "resolve": "c520909d-826a-4ff7-a66e-8d191ba3246d",
        "reject": null
      },
      {
        "id": "f695aee0-cae8-4fef-9916-420ee53c844c",
        "name": "记录到控制台",
        "key": "log_s2b46",
        "type": "log",
        "position_x": 3,
        "position_y": 37,
        "options": {
          "message": "{{$last}}"
        },
        "resolve": "088efa63-4cbe-4796-896d-b4b19adc4c43",
        "reject": null
      },
      {
        "id": "f6edda51-ac32-4e82-a625-8d6a4df7abb5",
        "name": "计算单题得分",
        "key": "exec_compute_score",
        "type": "exec",
        "position_x": 39,
        "position_y": 19,
        "options": {
          "code": "module.exports = async function(data) {\n    const q = data.submitted_questions[0];\n    // 注意submitted_question是个列表，我们每次只更新一个所以只管列表第一项。\n\tconst q_type = q.question_type;\n    // const answer = data.item_read_questions[0].answer; // 以前是这么写的，现在直接从submitted_question中获取了。\n    const answer = q.correct_ans;\n          \n    const submitted_answer = data.submitted_answer;\n    \n    function arraysEqual(arr1, arr2) {\n        // 如果长度不同，直接返回 false\n        if (arr1.length !== arr2.length) {\n            return false;\n        }\n\n        // 排序后逐个比较元素\n        arr1.sort();\n        arr2.sort();\n\n        // 比较每个元素\n        for (let i = 0; i < arr1.length; i++) {\n            if (arr1[i] !== arr2[i]) {\n                return false;\n            }\n        }\n\n        // 如果所有元素都相同，返回 true\n        return true;\n    }\n    \n    let true_status = 0;\n    if ( [\"q_mc_single\", \"q_mc_binary\"].includes(q_type) ){\n        if (answer === submitted_answer) {\n            true_status = 1;\n        } else {\n            true_status = 0;\n        }\n    } else if ( [\"q_mc_multi\", \"q_mc_flexible\"].includes(q_type) ){\n        const answer_json = JSON.parse(answer);\n        const submitted_answer_json = JSON.parse(submitted_answer)\n        if ( submitted_answer_json.length === 0) {\n\t\t\t// 如果提交的答案是空列表，直接0分。\n            true_status = 0;\n        } else if (submitted_answer_json.every(element => answer_json.includes(element))) {\n            // 如果包含关系\n            if (arraysEqual(submitted_answer_json, answer_json)) {\n                // 如果完全相等\n                true_status = 1;\n            } else {\n                true_status = 0.5;\n            }\n        } else {\n            true_status = 0;\n        }\n    }\n    \n    const score = true_status * q.point_value\n    \n    return {\n        answer,\n        submitted_answer,\n        true_status,\n        score\n    };\n}"
        },
        "resolve": "f695aee0-cae8-4fef-9916-420ee53c844c",
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "594867ab-5de7-4ac7-84bd-2eff41e26592",
    "name": "【考试算分】自动执行 - Duplicated",
    "icon": "bolt",
    "color": null,
    "description": "每次submitted_questions答案更新时，得分更新，层层向上汇总。",
    "trigger": "event",
    "options": {
      "type": "action",
      "scope": [
        "items.update"
      ],
      "collections": [
        "submitted_questions"
      ]
    },
    "operation": "0fe6cfdc-a52c-41b5-bf6b-8aa2eb2cb2e8",
    "operations": [
      {
        "id": "0a7f171c-4001-4944-8d21-c2e4bcaa26ad",
        "name": "得分总分更新到submitted_peper",
        "key": "item_update_submitted_papers",
        "type": "item-update",
        "position_x": 39,
        "position_y": 91,
        "options": {
          "collection": "submitted_papers",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{submitted_paper_chapters[0].submitted_paper}}"
              }
            }
          },
          "payload": {
            "score": "{{exec_sum_chapter_score}}"
          }
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "0fe6cfdc-a52c-41b5-bf6b-8aa2eb2cb2e8",
        "name": "注意",
        "key": "log_jftwy",
        "type": "log",
        "position_x": 18,
        "position_y": 1,
        "options": {
          "message": "注意这里一定是action类型，要等更新事件完成了再执行，而非阻止事件本身。"
        },
        "resolve": "5245cbda-938c-4f6f-b126-fb49cbcfe76d",
        "reject": null
      },
      {
        "id": "1490d435-2c9a-4ab2-a0ee-8e3eeb74f903",
        "name": "记录到控制台",
        "key": "log_s2b46",
        "type": "log",
        "position_x": 3,
        "position_y": 37,
        "options": {
          "message": "{{$last}}"
        },
        "resolve": "25e5fa19-81d6-489a-85d9-263dda413bb8",
        "reject": null
      },
      {
        "id": "22e5dad5-e4fd-4b72-9417-2587118b2181",
        "name": "运行脚本求和question的score到chapter",
        "key": "exec_sum_question_score",
        "type": "exec",
        "position_x": 21,
        "position_y": 55,
        "options": {
          "code": "module.exports = async function(data) {\n    const chapter_question_list = data.submitted_chapter_quesions;\n\tlet sum_question_score = chapter_question_list\n    \t.reduce((sum, item) => sum + Number(item.score), 0);\n\treturn sum_question_score;\n}"
        },
        "resolve": "d71665ff-3fa0-49d5-af3b-662ff937202f",
        "reject": null
      },
      {
        "id": "25e5fa19-81d6-489a-85d9-263dda413bb8",
        "name": "更新submitted_questions_score",
        "key": "submitted_questions_score",
        "type": "item-update",
        "position_x": 21,
        "position_y": 37,
        "options": {
          "payload": {
            "score": "{{exec_compute_score.score}}"
          },
          "collection": "submitted_questions",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.keys[0]}}"
              }
            }
          }
        },
        "resolve": "fc6b7a0a-05ef-406b-a661-0403a1b25e2a",
        "reject": null
      },
      {
        "id": "2970ee24-d0b0-4c5c-890c-996429f11155",
        "name": "运行脚本求和chapter的score到paper",
        "key": "exec_sum_chapter_score",
        "type": "exec",
        "position_x": 39,
        "position_y": 73,
        "options": {
          "code": "module.exports = async function(data) {\n    const paper_chapter_list = data.item_read_paper_chapters;\n\tlet sum_chapter_score = paper_chapter_list\n    \t.reduce((sum, item) => sum + Number(item.score), 0);\n\treturn sum_chapter_score;\n}"
        },
        "resolve": "0a7f171c-4001-4944-8d21-c2e4bcaa26ad",
        "reject": null
      },
      {
        "id": "5245cbda-938c-4f6f-b126-fb49cbcfe76d",
        "name": "读取submitted_questions",
        "key": "submitted_questions",
        "type": "item-read",
        "position_x": 35,
        "position_y": 1,
        "options": {
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.keys[0]}}"
              }
            }
          },
          "collection": "submitted_questions"
        },
        "resolve": "b4a79f4f-5ae8-4a5a-a17b-cf140e23118a",
        "reject": null
      },
      {
        "id": "533c4e22-b610-4417-8d15-1d7c0a784f9e",
        "name": "读取原题目（为了获得答案）",
        "key": "item_read_questions",
        "type": "item-read",
        "position_x": 21,
        "position_y": 19,
        "options": {
          "collection": "questions",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{submitted_questions[0].question}}"
              }
            }
          }
        },
        "resolve": "54f81d8a-92d1-42e6-856e-c7f488c1c254",
        "reject": null
      },
      {
        "id": "54f81d8a-92d1-42e6-856e-c7f488c1c254",
        "name": "计算单题得分",
        "key": "exec_compute_score",
        "type": "exec",
        "position_x": 39,
        "position_y": 19,
        "options": {
          "code": "module.exports = async function(data) {\n    const q = data.submitted_questions[0];\n    // 注意submitted_question是个列表，我们每次只更新一个所以只管列表第一项。\n\tconst q_type = q.question_type;\n    const answer = data.item_read_questions[0].answer;\n    \n    const submitted_answer = data.submitted_answer;\n    \n    function arraysEqual(arr1, arr2) {\n        // 如果长度不同，直接返回 false\n        if (arr1.length !== arr2.length) {\n            return false;\n        }\n\n        // 排序后逐个比较元素\n        arr1.sort();\n        arr2.sort();\n\n        // 比较每个元素\n        for (let i = 0; i < arr1.length; i++) {\n            if (arr1[i] !== arr2[i]) {\n                return false;\n            }\n        }\n\n        // 如果所有元素都相同，返回 true\n        return true;\n    }\n    \n    let true_status = 0;\n    if ( [\"q_mc_single\", \"q_mc_binary\"].includes(q_type) ){\n        if (answer === submitted_answer) {\n            true_status = 1;\n        } else {\n            true_status = 0;\n        }\n    } else if ( [\"q_mc_multi\", \"q_mc_flexible\"].includes(q_type) ){\n        const answer_json = JSON.parse(answer);\n        const submitted_answer_json = JSON.parse(submitted_answer)\n        if ( submitted_answer_json.length === 0) {\n\t\t\t// 如果提交的答案是空列表，直接0分。\n            true_status = 0;\n        } else if (submitted_answer_json.every(element => answer_json.includes(element))) {\n            // 如果包含关系\n            if (arraysEqual(submitted_answer_json, answer_json)) {\n                // 如果完全相等\n                true_status = 1;\n            } else {\n                true_status = 0.5;\n            }\n        } else {\n            true_status = 0;\n        }\n    }\n    \n    const score = true_status * q.point_value\n    \n    return {\n        answer,\n        submitted_answer,\n        true_status,\n        score\n    };\n}"
        },
        "resolve": "1490d435-2c9a-4ab2-a0ee-8e3eeb74f903",
        "reject": null
      },
      {
        "id": "6e01abfe-fe8a-42ee-aa54-a21b1fb68f7b",
        "name": "查询当前submit_chapter信息",
        "key": "submitted_paper_chapters",
        "type": "item-read",
        "position_x": 3,
        "position_y": 73,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{item_update_submitted_chapters[0]}}"
              }
            }
          }
        },
        "resolve": "c374a4f9-9f3e-4027-8d33-8241c64efccf",
        "reject": null
      },
      {
        "id": "b4a79f4f-5ae8-4a5a-a17b-cf140e23118a",
        "name": "打印submitted_questions[0]详情",
        "key": "log_kphe8",
        "type": "log",
        "position_x": 52,
        "position_y": 1,
        "options": {
          "message": "{{submitted_questions[0]}}"
        },
        "resolve": "b7a0f33d-68e7-4ea6-ab20-02039877102a",
        "reject": null
      },
      {
        "id": "b7a0f33d-68e7-4ea6-ab20-02039877102a",
        "name": "根据题型定义学生提交的答案（字符串）",
        "key": "submitted_answer",
        "type": "exec",
        "position_x": 3,
        "position_y": 19,
        "options": {
          "code": "module.exports = async function(data) {\n    const q = data.submitted_questions[0];\n\tconst q_type = q.question_type;\n\tlet submitted_answer;\n    if (q_type === \"q_mc_single\") {\n        submitted_answer = q.submitted_ans_q_mc_single;\n    } else if (q_type === \"q_mc_multi\") {\n        submitted_answer = JSON.stringify(q.submitted_ans_q_mc_multi);\n    } else if (q_type === \"q_mc_binary\") {\n        submitted_answer = q.submitted_ans_q_mc_binary;\n    } else if (q_type === \"q_mc_flexible\") {\n        submitted_answer = JSON.stringify(q.submitted_ans_q_mc_flexible);\n    }\n\t// 为避免类型混乱，先全都转化为字符串来存储。\n\treturn submitted_answer;\n}"
        },
        "resolve": "533c4e22-b610-4417-8d15-1d7c0a784f9e",
        "reject": null
      },
      {
        "id": "c374a4f9-9f3e-4027-8d33-8241c64efccf",
        "name": "读取当前章节的试卷的所有章节数据",
        "key": "item_read_paper_chapters",
        "type": "item-read",
        "position_x": 21,
        "position_y": 73,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "submitted_paper": {
                "_eq": "{{submitted_paper_chapters[0].submitted_paper}}"
              }
            }
          }
        },
        "resolve": "2970ee24-d0b0-4c5c-890c-996429f11155",
        "reject": null
      },
      {
        "id": "d71665ff-3fa0-49d5-af3b-662ff937202f",
        "name": "得分总分更新到submitted_chapter",
        "key": "item_update_submitted_chapters",
        "type": "item-update",
        "position_x": 39,
        "position_y": 55,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{submitted_questions[0].submitted_paper_chapter}}"
              }
            }
          },
          "payload": {
            "score": "{{exec_sum_question_score}}"
          }
        },
        "resolve": "6e01abfe-fe8a-42ee-aa54-a21b1fb68f7b",
        "reject": null
      },
      {
        "id": "fc6b7a0a-05ef-406b-a661-0403a1b25e2a",
        "name": "查询当前submit_q 所属的submit chapter的所有submit_q",
        "key": "submitted_chapter_quesions",
        "type": "item-read",
        "position_x": 3,
        "position_y": 55,
        "options": {
          "collection": "submitted_questions",
          "query": {
            "filter": {
              "submitted_paper_chapter": {
                "_eq": "{{submitted_questions[0].submitted_paper_chapter}}"
              }
            }
          }
        },
        "resolve": "22e5dad5-e4fd-4b72-9417-2587118b2181",
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "70f10488-bf78-42ca-acb0-b740bd30943a",
    "name": "【考试算分trigger-02】自动触发",
    "icon": "bolt",
    "color": null,
    "description": "交卷时自动触发算分流程",
    "trigger": "event",
    "options": {
      "type": "action",
      "scope": [
        "items.update"
      ],
      "collections": [
        "submitted_exams"
      ]
    },
    "operation": "87e83726-e2c2-44a8-8178-2543026f79e3",
    "operations": [
      {
        "id": "70fa7b90-ab97-43b0-903e-30216f643b49",
        "name": "休眠",
        "key": "sleep_apeqd",
        "type": "sleep",
        "position_x": 37,
        "position_y": 1,
        "options": {},
        "resolve": "8a6cce1a-4151-4e11-9342-f13ba4db58f1",
        "reject": null
      },
      {
        "id": "87e83726-e2c2-44a8-8178-2543026f79e3",
        "name": "条件",
        "key": "condition_submit_status_done",
        "type": "condition",
        "position_x": 19,
        "position_y": 1,
        "options": {
          "filter": {
            "$trigger": {
              "payload": {
                "submit_status": {
                  "_eq": "done"
                }
              }
            }
          }
        },
        "resolve": "70fa7b90-ab97-43b0-903e-30216f643b49",
        "reject": null
      },
      {
        "id": "8a6cce1a-4151-4e11-9342-f13ba4db58f1",
        "name": "触发流程",
        "key": "trigger_qjsz5",
        "type": "trigger",
        "position_x": 4,
        "position_y": 19,
        "options": {
          "payload": "{{ $trigger.keys }}",
          "flow": "039cdff5-9878-4981-b836-d9d87b022a2c"
        },
        "resolve": null,
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "a7fcd0ee-d432-4d15-b4f7-f08594c48e0e",
    "name": "【考试算分triggered-02】接收chapter",
    "icon": "bolt",
    "color": null,
    "description": "计算试卷每章节的得分",
    "trigger": "operation",
    "options": {
      "return": "$last"
    },
    "operation": "79755127-380e-413e-8e0d-84d883e52b93",
    "operations": [
      {
        "id": "7241fa6f-b07d-443c-9dec-0e08ed766381",
        "name": "得分总分更新到submitted_chapter",
        "key": "item_update_submitted_chapters",
        "type": "item-update",
        "position_x": 5,
        "position_y": 19,
        "options": {
          "collection": "submitted_paper_chapters",
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger}}"
              }
            }
          },
          "payload": {
            "score": "{{exec_sum_question_score}}"
          }
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "79755127-380e-413e-8e0d-84d883e52b93",
        "name": "查询当前submit chapter的所有submit_q",
        "key": "submitted_chapter_questions",
        "type": "item-read",
        "position_x": 19,
        "position_y": 1,
        "options": {
          "collection": "submitted_questions",
          "query": {
            "filter": {
              "submitted_paper_chapter": {
                "_eq": "{{$trigger}}"
              }
            }
          }
        },
        "resolve": "977a29f2-e773-4665-87fe-eb1b3378240f",
        "reject": null
      },
      {
        "id": "977a29f2-e773-4665-87fe-eb1b3378240f",
        "name": "运行脚本求和question的score",
        "key": "exec_sum_question_score",
        "type": "exec",
        "position_x": 37,
        "position_y": 1,
        "options": {
          "code": "module.exports = async function(data) {\n    const chapter_question_list = data.submitted_chapter_questions;\n\tlet sum_question_score = chapter_question_list.reduce((sum, item) => {\n        // sum + Number(item.score), \n        // 注意要处理item.score=null的情况。\n        // 如果 score 为 null 或 undefined，则视为 0\n        const score = item.score == null ? 0 : Number(item.score);\n        return !isNaN(score) ? sum + score : sum;\n    }, 0);\n    // reduce的第二个参数表示初始累加值。\n\treturn sum_question_score;\n    //return chapter_question_list;\n}"
        },
        "resolve": "7241fa6f-b07d-443c-9dec-0e08ed766381",
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "c458efee-05eb-4a0a-846c-e14ee15e7491",
    "name": "【用户】创建学生后自动创建对应directus_user",
    "icon": "bolt",
    "color": null,
    "description": null,
    "trigger": "event",
    "options": {
      "type": "action",
      "scope": [
        "items.create"
      ],
      "collections": [
        "students"
      ]
    },
    "operation": "2a14df6d-9517-4d3e-ac18-846912ebcca1",
    "operations": [
      {
        "id": "2a14df6d-9517-4d3e-ac18-846912ebcca1",
        "name": "互联网钩子 / 请求 URL",
        "key": "request_vlpp7",
        "type": "request",
        "position_x": 19,
        "position_y": 1,
        "options": {
          "url": " http://127.0.0.1:8055/users",
          "headers": [
            {
              "header": "Authorization",
              "value": "\tBearer xoMOrTYoHHIB4oa8nNCHjlNfZWMR8ykM"
            }
          ],
          "body": "{\n\t\"email\": \"testapi@yahoo.cn\",\n\t\"password\": \"testapi\"\n}"
        },
        "resolve": null,
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "df6ff29f-daa6-4f9b-8a91-b0f974ff230a",
    "name": "【字段】题目字段管理-题目保存时，删掉非当前type的字段",
    "icon": "bolt",
    "color": null,
    "description": "questions相关字段",
    "trigger": "event",
    "options": {
      "type": "action",
      "scope": [
        "items.create"
      ]
    },
    "operation": null,
    "operations": [],
    "flow_manager_category": null,
    "accountability": "all"
  },
  {
    "id": "f5a7c264-c50b-4c7f-bbb6-184c686d2d99",
    "name": "【考试结束时间计算】",
    "icon": "bolt",
    "color": null,
    "description": "这边还得是filter，因为得确保都更新完了。",
    "trigger": "event",
    "options": {
      "type": "action",
      "scope": [
        "items.update"
      ],
      "collections": [
        "submitted_exams"
      ]
    },
    "operation": "14a8a686-28d7-43a5-bd69-71a0245e4aca",
    "operations": [
      {
        "id": "14a8a686-28d7-43a5-bd69-71a0245e4aca",
        "name": "读取submit_exam数据",
        "key": "item_read_submit_exams",
        "type": "item-read",
        "position_x": 18,
        "position_y": 1,
        "options": {
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.keys[0]}}"
              }
            }
          },
          "collection": "submitted_exams"
        },
        "resolve": "b6f819e3-76a8-4c08-9ba7-f9b1f2499871",
        "reject": null
      },
      {
        "id": "1a4e7602-ce89-4f47-849e-667e07778fde",
        "name": "记录到控制台",
        "key": "log_3y8v0",
        "type": "log",
        "position_x": 39,
        "position_y": 19,
        "options": {
          "message": "{{$trigger}}"
        },
        "resolve": null,
        "reject": null
      },
      {
        "id": "864695aa-7f37-4388-8943-1c38107b57aa",
        "name": "运行脚本，返回一个日期时间字符串",
        "key": "expected_end_time",
        "type": "exec",
        "position_x": 4,
        "position_y": 19,
        "options": {
          "code": "module.exports = async function(data) {\n    // 解析字符串为日期\n    const submit_exam = data.item_read_submit_exams[0];\n    const exam = data.item_read_exams[0];\n    const actual_start_time = submit_exam.actual_start_time;  // 导出的时间是字符串类型。\n    const duration = exam.duration; // 考试持续时间（分钟）\n    const extra_time = submit_exam.extra_time; // 延时（分钟）\n    \n    // 先根据实际开始作答时间和考试时长，计算应交卷时间\n    const expected_end_time = new Date(actual_start_time);\n    expected_end_time.setMinutes(expected_end_time.getMinutes() + duration + extra_time);\n    \n    // 注意：Date对象在directus中能正常运算，但不能打印。\n    const expected_end_time_str = expected_end_time.toISOString();\n    \n\t//return ;\n    return expected_end_time_str;\n}"
        },
        "resolve": "fb8b57d5-1497-4139-b158-318cbc21281b",
        "reject": null
      },
      {
        "id": "b6f819e3-76a8-4c08-9ba7-f9b1f2499871",
        "name": "读取exam数据",
        "key": "item_read_exams",
        "type": "item-read",
        "position_x": 36,
        "position_y": 1,
        "options": {
          "query": {
            "filter": {
              "id": {
                "_eq": "{{item_read_submit_exams[0].exam}}"
              }
            }
          },
          "collection": "exams"
        },
        "resolve": "864695aa-7f37-4388-8943-1c38107b57aa",
        "reject": null
      },
      {
        "id": "fb8b57d5-1497-4139-b158-318cbc21281b",
        "name": "更新触发的submitted_exam",
        "key": "item_update_submitted_exam",
        "type": "item-update",
        "position_x": 22,
        "position_y": 19,
        "options": {
          "query": {
            "filter": {
              "id": {
                "_eq": "{{$trigger.keys[0]}}"
              }
            }
          },
          "collection": "submitted_exams",
          "payload": {
            "expected_end_time": "{{expected_end_time}}"
          }
        },
        "resolve": "1a4e7602-ce89-4f47-849e-667e07778fde",
        "reject": null
      }
    ],
    "flow_manager_category": null,
    "accountability": "all"
  }
]